generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model Content {
  id          String        @id @default(uuid()) @map("_id")
  contentType String
  contentName String
  soundGroup  String
  subGroup    String?
  createdAt   DateTime      @default(now())
  status      ContentStatus @default(PENDING)

  userId String? @db.ObjectId
  user   User?   @relation(fields: [userId], references: [id])

  fileId String @unique
  file   File   @relation(fields: [fileId], references: [id])

  constructionkitId String?
  constructionkit   Constructionkit? @relation("KitContents", fields: [constructionkitId], references: [id])

  metadataId String
  metadata   Metadata @relation("ContentMetadata", fields: [metadataId], references: [id])

  loopandmidiLoop Loopandmidi[] @relation("LoopContent")
  loopandmidiMidi Loopandmidi[] @relation("MidiContent")

  presetLoop    Preset[] @relation("PresetLoop")
  presetMidi    Preset[] @relation("PresetMidi")
  presetContent Preset[] @relation("PresetMain")

  usedAsDefaultIn Constructionkit[] @relation("DefaultFullLoop")

  orderItems OrderItem[]
}

model Loopandmidi {
  id         String        @id @default(uuid()) @map("_id")
  name       String
  soundGroup String
  subGroup   String?
  createdAt  DateTime      @default(now())
  status     ContentStatus @default(PENDING)

  userId String? @db.ObjectId
  user   User?   @relation(fields: [userId], references: [id])

  loopContentId String?
  loopContent   Content? @relation("LoopContent", fields: [loopContentId], references: [id])

  midiContentId String?
  midiContent   Content? @relation("MidiContent", fields: [midiContentId], references: [id])

  metadataId String
  metadata   Metadata @relation("Metadata_Loopandmidis", fields: [metadataId], references: [id])

  constructionkitId String?
  constructionkit   Constructionkit? @relation("KitLoops", fields: [constructionkitId], references: [id])
}

model Preset {
  id        String        @id @default(uuid()) @map("_id")
  name      String
  createdAt DateTime      @default(now())
  status    ContentStatus @default(PENDING)

  userId     String? @db.ObjectId
  user       User?   @relation(fields: [userId], references: [id])
  soundGroup String
  subGroup   String?

  loopContentId String?
  loopContent   Content? @relation("PresetLoop", fields: [loopContentId], references: [id])

  midiContentId String?
  midiContent   Content? @relation("PresetMidi", fields: [midiContentId], references: [id])

  presetContentId String?
  presetContent   Content? @relation("PresetMain", fields: [presetContentId], references: [id])

  metadataId String
  metadata   Metadata @relation("PresetMetadata", fields: [metadataId], references: [id])

  constructionkitId String?
  constructionkit   Constructionkit? @relation("KitPresets", fields: [constructionkitId], references: [id])
}

model Constructionkit {
  id          String        @id @default(uuid()) @map("_id")
  kitName     String
  description String?
  createdAt   DateTime      @default(now())
  price       Float         @default(0)
  status      ContentStatus @default(PENDING)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  metadataId String
  metadata   Metadata @relation("KitMetadata", fields: [metadataId], references: [id])

  contents     Content[]     @relation("KitContents")
  presets      Preset[]      @relation("KitPresets")
  loopAndMidis Loopandmidi[] @relation("KitLoops")

  defaultFullLoopId String
  defaultFullLoop   Content @relation("DefaultFullLoop", fields: [defaultFullLoopId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  orderItems OrderItem[]
}

model Metadata {
  id          String   @id @default(uuid()) @map("_id")
  styles      String[]
  moods       String[]
  processing  String[]
  soundDesign String[]
  bpm         String?
  key         String?

  contents         Content[]         @relation("ContentMetadata")
  constructionkits Constructionkit[] @relation("KitMetadata")
  loopAndMidis     Loopandmidi[]     @relation("Metadata_Loopandmidis")
  presets          Preset[]          @relation("PresetMetadata")
}

model File {
  id        String   @id @default(uuid()) @map("_id")
  fileName  String
  awsKey    String
  createdAt DateTime @default(now())
  content   Content?
}

model User {
  id                 String              @id @default(auto()) @map("_id") @db.ObjectId
  username           String              @unique
  email              String              @unique
  password           String
  name               String
  surname            String?
  type               UserType            @default(USER)
  country            String?
  city               String?
  artistName         String?
  artistPhoto        String?
  quote              String?
  instagram          String?
  soundcloud         String?
  spotify            String?
  tiktok             String?
  facebook           String?
  youtube            String?
  x                  String?
  linktree           String?
  beatport           String?
  bandcamp           String?
  appleMusic         String?
  track1             String?
  track2             String?
  track3             String?
  billing            Json?
  approvedAt         DateTime?
  canCreateSamples   Boolean             @default(false)
  canCreateSerum     Boolean             @default(false)
  canCreateDiva      Boolean             @default(false)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  artistApplications ArtistApplication[]
  constructionkits   Constructionkit[]
  sessions           Session[]
  riskLogs           RiskLog[]
  contents           Content[]
  loopandmidis       Loopandmidi[]
  presets            Preset[]

  telegramChatId          String? @unique
  telegramUsername        String?
  telegramConnectionToken String? @unique
  profileViews            Int     @default(0)
  messageClicks           Int     @default(0)
}

model Session {
  id                String   @id @default(uuid()) @map("_id")
  userId            String   @db.ObjectId
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshTokenHash  String // Storing hash for security
  deviceFingerprint String
  userAgent         String?
  ipAddress         String?
  riskScore         Int      @default(0)
  expiresAt         DateTime
  lastActive        DateTime @default(now())
  createdAt         DateTime @default(now())

  riskLogs RiskLog[]

  @@index([userId])
}

model RiskLog {
  id        String   @id @default(uuid()) @map("_id")
  sessionId String
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  event     String
  score     Int
  details   Json?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([sessionId])
}

model ArtistApplication {
  id                   String            @id @default(auto()) @map("_id") @db.ObjectId
  userId               String            @db.ObjectId
  user                 User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  artistName           String
  email                String
  photoUrl             String?
  photoKey             String?
  instagram            String?
  tiktok               String?
  facebook             String?
  youtube              String?
  x                    String?
  linktree             String?
  spotify              String?
  soundcloud           String?
  beatport             String?
  bandcamp             String?
  appleMusic           String?
  track1               String?
  track2               String?
  track3               String?
  quote                String
  canCreateLoops       Boolean
  canCreateSerum       Boolean
  canCreateDiva        Boolean
  status               ApplicationStatus @default(PENDING)
  reviewNotes          String?
  reviewedAt           DateTime?
  reviewedBy           String?
  criteriaStyle        CriteriaStatus?
  criteriaQuality      CriteriaStatus?
  criteriaPresentation CriteriaStatus?
  criteriaStatement    CriteriaStatus?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
}

model News {
  id        String   @id @default(cuid()) @map("_id")
  title     String
  content   String
  isActive  Boolean  @default(true)
  priority  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  @@map("news")
}

enum ApplicationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum CriteriaStatus {
  APPROVED
  REFUSED
  NOT_REVIEWED
}

enum UserType {
  USER
  ARTIST
  ADMIN
}

enum OrderStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model OrderItem {
  id        String           @id @default(uuid()) @map("_id")
  orderId   String
  contentId String?
  content   Content?         @relation(fields: [contentId], references: [id])
  kitId     String?
  kit       Constructionkit? @relation(fields: [kitId], references: [id])
  price     Float
  createdAt DateTime         @default(now())
}

enum ContentStatus {
  PENDING
  APPROVED
  REJECTED
  NEEDS_FIX
}
